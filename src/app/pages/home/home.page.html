<ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar>
    <ion-title>
      <div class="header-content">
        <span class="app-title">GasApp</span>
      </div>
    </ion-title>
    <ion-buttons slot="start">
      <ion-select
        [(ngModel)]="chosenGasType"
        (ionChange)="changeGasType($event)"
        interface="action-sheet"
        class="fuel-select">
        <ion-select-option
          *ngFor="let gasType of gasTypes"
          [value]="gasType.Id">
          {{ gasType.Descritivo }}
        </ion-select-option>
      </ion-select>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button (click)="handleRefresh($event)" class="refresh-btn">
        <ion-icon name="refresh-outline" [class.spinning]="isRefreshing"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Loading State -->
  <div *ngIf="!loaded" class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p class="loading-text">A carregar...</p>
  </div>

  <!-- Pull to Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      refreshingSpinner="circles">
    </ion-refresher-content>
  </ion-refresher>

  <!-- Location Permission Warning -->
  <div *ngIf="locationPermissionDenied && loaded" class="location-warning" (click)="requestLocationPermission()">
    <ion-icon name="location-outline"></ion-icon>
    <span>Toque para ativar localização</span>
  </div>

  <!-- Main Content -->
  <div *ngIf="loaded" class="content-wrapper">

    <!-- Quick Stats -->
    <div class="quick-stats">
      <div class="stat">
        <ion-icon name="pricetag" color="primary"></ion-icon>
        <span class="stat-value">{{ getAverageNearPriceLabel() }}</span>
        <span class="stat-label">preço médio</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat">
        <ion-icon name="navigate" color="success"></ion-icon>
        <span class="stat-value">{{ getClosestDistanceLabel() }}</span>
        <span class="stat-label">mais perto</span>
      </div>
    </div>

    <!-- Section: Cheapest Nearby -->
    <div class="section" *ngIf="nearCheapStations.length > 0">
      <div class="section-header">
        <span class="section-title">Mais baratas perto</span>
        <span class="section-count">{{ nearCheapStationsCount }}</span>
      </div>
      <div class="stations-list">
        <app-gas-station-card-small
          *ngFor="let station of getVisibleStations(nearCheapStations, cheapExpanded)"
          [gasStation]="station"
          [location]="myLocation"
          (stationClicked)="viewStationDetails($event)">
        </app-gas-station-card-small>
      </div>
      <button
        *ngIf="nearCheapStations.length > visibleCount"
        class="expand-btn"
        (click)="cheapExpanded = !cheapExpanded">
        <ion-icon [name]="cheapExpanded ? 'chevron-up' : 'chevron-down'"></ion-icon>
        <span>{{ cheapExpanded ? 'Ver menos' : 'Ver mais ' + (nearCheapStations.length - visibleCount) }}</span>
      </button>
    </div>

    <!-- Section: Nearest -->
    <div class="section" *ngIf="nearGasStations.length > 0">
      <div class="section-header">
        <span class="section-title">Mais perto</span>
        <span class="section-count">{{ nearNearestStationsCount }}</span>
      </div>
      <div class="stations-list">
        <app-gas-station-card-small
          *ngFor="let station of getVisibleStations(nearGasStations, nearExpanded)"
          [gasStation]="station"
          [location]="myLocation"
          (stationClicked)="viewStationDetails($event)">
        </app-gas-station-card-small>
      </div>
      <button
        *ngIf="nearGasStations.length > visibleCount"
        class="expand-btn"
        (click)="nearExpanded = !nearExpanded">
        <ion-icon [name]="nearExpanded ? 'chevron-up' : 'chevron-down'"></ion-icon>
        <span>{{ nearExpanded ? 'Ver menos' : 'Ver mais ' + (nearGasStations.length - visibleCount) }}</span>
      </button>
    </div>

    <!-- Empty State -->
    <div *ngIf="nearCheapStations.length === 0 && nearGasStations.length === 0" class="empty-state">
      <ion-icon name="location-outline"></ion-icon>
      <p>Nenhum posto encontrado</p>
      <ion-button fill="outline" size="small" (click)="handleRefresh($event)">
        Tentar novamente
      </ion-button>
    </div>

  </div>
</ion-content>
